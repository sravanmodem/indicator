{% extends "base.html" %}

{% block title %}Signal Management{% endblock %}
{% block page_title %}Signal Management{% endblock %}
{% block page_subtitle %}Create and manage trading signals for all users{% endblock %}

{% block content %}
<div class="space-y-6 animate-fade-in">

    <!-- Create Signal Section -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                <svg class="w-5 h-5 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Create New Signal
            </h2>
            <span class="px-3 py-1 rounded-full text-xs font-bold bg-green-500/20 text-green-400" id="marketStatus">
                Market Open
            </span>
        </div>

        <form action="/admin/signals/create" method="POST" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Index -->
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Index</label>
                    <select name="index" required class="w-full px-4 py-3 rounded-lg bg-surface-800 border border-surface-700 text-white focus:outline-none focus:border-primary-500">
                        <option value="NIFTY">NIFTY</option>
                        <option value="BANKNIFTY">BANKNIFTY</option>
                        <option value="SENSEX">SENSEX</option>
                    </select>
                </div>

                <!-- Signal Type -->
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Signal Type</label>
                    <select name="signal_type" required class="w-full px-4 py-3 rounded-lg bg-surface-800 border border-surface-700 text-white focus:outline-none focus:border-primary-500">
                        <option value="CE">CE (Call)</option>
                        <option value="PE">PE (Put)</option>
                    </select>
                </div>

                <!-- Strike Price -->
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Strike Price</label>
                    <input type="number" name="strike_price" required step="50" placeholder="24500"
                           class="w-full px-4 py-3 rounded-lg bg-surface-800 border border-surface-700 text-white placeholder-slate-500 focus:outline-none focus:border-primary-500">
                </div>

                <!-- Entry Price -->
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Entry Price</label>
                    <input type="number" name="entry_price" required step="0.05" placeholder="150.00"
                           class="w-full px-4 py-3 rounded-lg bg-surface-800 border border-surface-700 text-white placeholder-slate-500 focus:outline-none focus:border-primary-500">
                </div>

                <!-- Target Price -->
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Target Price</label>
                    <input type="number" name="target_price" required step="0.05" placeholder="180.00"
                           class="w-full px-4 py-3 rounded-lg bg-surface-800 border border-surface-700 text-white placeholder-slate-500 focus:outline-none focus:border-primary-500">
                </div>

                <!-- Stop Loss -->
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Stop Loss</label>
                    <input type="number" name="stop_loss" required step="0.05" placeholder="135.00"
                           class="w-full px-4 py-3 rounded-lg bg-surface-800 border border-surface-700 text-white placeholder-slate-500 focus:outline-none focus:border-primary-500">
                </div>

                <!-- Quantity -->
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Quantity (Lots)</label>
                    <input type="number" name="quantity" required min="1" value="1"
                           class="w-full px-4 py-3 rounded-lg bg-surface-800 border border-surface-700 text-white placeholder-slate-500 focus:outline-none focus:border-primary-500">
                </div>

                <!-- Expiry -->
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Expiry</label>
                    <input type="date" name="expiry" required
                           class="w-full px-4 py-3 rounded-lg bg-surface-800 border border-surface-700 text-white focus:outline-none focus:border-primary-500">
                </div>
            </div>

            <!-- Notes -->
            <div>
                <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Signal Notes (Optional)</label>
                <textarea name="notes" rows="2" placeholder="Add any notes about this signal..."
                          class="w-full px-4 py-3 rounded-lg bg-surface-800 border border-surface-700 text-white placeholder-slate-500 focus:outline-none focus:border-primary-500 resize-none"></textarea>
            </div>

            <div class="flex items-center justify-between pt-4 border-t border-surface-700">
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="auto_execute" checked class="w-4 h-4 rounded border-surface-600 bg-surface-800 text-primary-500 focus:ring-primary-500">
                        <span class="text-sm text-slate-300">Auto-execute for eligible users</span>
                    </label>
                </div>
                <button type="submit" class="px-6 py-3 rounded-lg bg-gradient-to-r from-primary-600 to-purple-600 hover:from-primary-500 hover:to-purple-500 text-white font-bold flex items-center gap-2 transition-all shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Broadcast Signal
                </button>
            </div>
        </form>
    </div>

    <!-- Active Signals -->
    <div class="card">
        <div class="p-4 border-b border-surface-700 flex items-center justify-between">
            <h2 class="text-lg font-bold text-white flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                Active Signals
            </h2>
            <span class="text-xs text-slate-500">Auto-refreshes every 5 seconds</span>
        </div>

        <div class="overflow-x-auto" hx-get="/htmx/admin/active-signals" hx-trigger="load, every 5s" hx-swap="innerHTML">
            <div class="p-8 text-center">
                <div class="animate-spin w-8 h-8 border-2 border-primary-500 border-t-transparent rounded-full mx-auto"></div>
                <p class="text-slate-500 mt-2">Loading active signals...</p>
            </div>
        </div>
    </div>

    <!-- Signal History -->
    <div class="card">
        <div class="p-4 border-b border-surface-700 flex items-center justify-between">
            <h2 class="text-lg font-bold text-white">Signal History</h2>
            <div class="flex items-center gap-4">
                <select id="filterIndex" class="px-3 py-2 rounded-lg bg-surface-800 border border-surface-700 text-white text-sm focus:outline-none focus:border-primary-500">
                    <option value="">All Indices</option>
                    <option value="NIFTY">NIFTY</option>
                    <option value="BANKNIFTY">BANKNIFTY</option>
                    <option value="SENSEX">SENSEX</option>
                </select>
                <select id="filterResult" class="px-3 py-2 rounded-lg bg-surface-800 border border-surface-700 text-white text-sm focus:outline-none focus:border-primary-500">
                    <option value="">All Results</option>
                    <option value="profit">Profit</option>
                    <option value="loss">Loss</option>
                </select>
                <input type="date" id="filterDate" class="px-3 py-2 rounded-lg bg-surface-800 border border-surface-700 text-white text-sm focus:outline-none focus:border-primary-500">
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider border-b border-slate-700/50 bg-surface-800/50">
                        <th class="p-4">Signal ID</th>
                        <th class="p-4">Time</th>
                        <th class="p-4">Index</th>
                        <th class="p-4">Type</th>
                        <th class="p-4">Strike</th>
                        <th class="p-4 text-right">Entry</th>
                        <th class="p-4 text-right">Exit</th>
                        <th class="p-4 text-right">P&L</th>
                        <th class="p-4 text-center">Executions</th>
                        <th class="p-4">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for signal in signals %}
                    <tr class="border-b border-slate-700/30 hover:bg-surface-800/50">
                        <td class="p-4 font-mono text-xs text-slate-400">{{ signal.signal_id[:8] }}</td>
                        <td class="p-4 text-slate-300">{{ signal.created_at }}</td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded text-xs font-bold
                                {% if signal.index == 'NIFTY' %}bg-blue-500/20 text-blue-400
                                {% elif signal.index == 'BANKNIFTY' %}bg-purple-500/20 text-purple-400
                                {% else %}bg-green-500/20 text-green-400{% endif %}">
                                {{ signal.index }}
                            </span>
                        </td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded text-xs font-bold {% if signal.signal_type == 'CE' %}bg-green-500/20 text-green-400{% else %}bg-red-500/20 text-red-400{% endif %}">
                                {{ signal.signal_type }}
                            </span>
                        </td>
                        <td class="p-4 font-mono text-white">{{ signal.strike_price }}</td>
                        <td class="p-4 text-right font-mono text-white">₹{{ "%.2f"|format(signal.entry_price) }}</td>
                        <td class="p-4 text-right font-mono text-white">
                            {% if signal.exit_price %}₹{{ "%.2f"|format(signal.exit_price) }}{% else %}-{% endif %}
                        </td>
                        <td class="p-4 text-right font-mono {% if signal.pnl and signal.pnl >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                            {% if signal.pnl %}{% if signal.pnl >= 0 %}+{% endif %}₹{{ "%.0f"|format(signal.pnl) }}{% else %}-{% endif %}
                        </td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 rounded text-xs font-bold bg-surface-700 text-slate-300">
                                {{ signal.execution_count }} / {{ signal.eligible_users }}
                            </span>
                        </td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded text-xs font-bold
                                {% if signal.status == 'active' %}bg-green-500/20 text-green-400
                                {% elif signal.status == 'completed' %}bg-blue-500/20 text-blue-400
                                {% else %}bg-slate-500/20 text-slate-400{% endif %}">
                                {{ signal.status }}
                            </span>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="p-8 text-center text-slate-500">
                            No signals found. Create your first signal above.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="p-4 border-t border-surface-700 flex items-center justify-between">
            <p class="text-sm text-slate-500">Showing {{ signals|length }} signals</p>
            <div class="flex items-center gap-2">
                <button class="px-3 py-1 rounded bg-surface-700 text-slate-400 hover:bg-surface-600 disabled:opacity-50" disabled>Previous</button>
                <button class="px-3 py-1 rounded bg-surface-700 text-slate-400 hover:bg-surface-600 disabled:opacity-50" disabled>Next</button>
            </div>
        </div>
    </div>

    <!-- Signal Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Total Signals</p>
                    <p class="text-xl font-bold text-white">{{ stats.total_signals }}</p>
                </div>
            </div>
        </div>

        <div class="card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Win Rate</p>
                    <p class="text-xl font-bold text-green-400">{{ "%.1f"|format(stats.win_rate) }}%</p>
                </div>
            </div>
        </div>

        <div class="card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Total P&L</p>
                    <p class="text-xl font-bold {% if stats.total_pnl >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                        {% if stats.total_pnl >= 0 %}+{% endif %}₹{{ "{:,.0f}".format(stats.total_pnl) }}
                    </p>
                </div>
            </div>
        </div>

        <div class="card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-amber-500/20 flex items-center justify-center">
                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                </div>
                <div>
                    <p class="text-xs text-slate-500 uppercase tracking-wider">Avg P&L/Signal</p>
                    <p class="text-xl font-bold text-white">₹{{ "{:,.0f}".format(stats.avg_pnl) }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Set default expiry to next Thursday
const today = new Date();
const day = today.getDay();
const daysUntilThursday = (4 - day + 7) % 7 || 7;
const nextThursday = new Date(today);
nextThursday.setDate(today.getDate() + daysUntilThursday);
document.querySelector('input[name="expiry"]').valueAsDate = nextThursday;

// Market status
function updateMarketStatus() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const currentTime = hours * 60 + minutes;
    const marketOpen = 9 * 60 + 15;  // 9:15 AM
    const marketClose = 15 * 60 + 30; // 3:30 PM
    const isWeekday = now.getDay() > 0 && now.getDay() < 6;

    const statusEl = document.getElementById('marketStatus');
    if (isWeekday && currentTime >= marketOpen && currentTime <= marketClose) {
        statusEl.textContent = 'Market Open';
        statusEl.className = 'px-3 py-1 rounded-full text-xs font-bold bg-green-500/20 text-green-400';
    } else {
        statusEl.textContent = 'Market Closed';
        statusEl.className = 'px-3 py-1 rounded-full text-xs font-bold bg-red-500/20 text-red-400';
    }
}
updateMarketStatus();
setInterval(updateMarketStatus, 60000);
</script>
{% endblock %}
