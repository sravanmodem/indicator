{% if error %}
<div class="p-6">
    <div class="text-center py-8">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
        </div>
        <p class="text-red-400 font-medium">{{ error }}</p>
        <p class="text-slate-500 text-sm mt-2">Please check your connection or try again later</p>
    </div>
</div>
{% elif chain %}
<div class="overflow-x-auto">
    <table class="w-full text-sm">
        <thead class="bg-gradient-to-r from-green-900/30 via-surface-800 to-red-900/30 text-slate-400 text-xs uppercase sticky top-0 z-10">
            <tr>
                <th colspan="4" class="px-3 py-3 text-center bg-green-500/10 border-b border-green-500/30">
                    <span class="text-green-400 font-bold">CALLS (CE)</span>
                </th>
                <th class="px-4 py-3 text-center bg-surface-700 border-b border-slate-600">
                    <span class="text-white font-bold">STRIKE</span>
                </th>
                <th colspan="4" class="px-3 py-3 text-center bg-red-500/10 border-b border-red-500/30">
                    <span class="text-red-400 font-bold">PUTS (PE)</span>
                </th>
            </tr>
            <tr class="text-[10px]">
                <th class="px-2 py-2 text-right text-green-400/70">OI</th>
                <th class="px-2 py-2 text-right text-green-400/70">Vol</th>
                <th class="px-2 py-2 text-right text-green-400/70">Chg%</th>
                <th class="px-2 py-2 text-right text-green-400/70">LTP</th>
                <th class="px-3 py-2 text-center bg-surface-700/50"></th>
                <th class="px-2 py-2 text-left text-red-400/70">LTP</th>
                <th class="px-2 py-2 text-left text-red-400/70">Chg%</th>
                <th class="px-2 py-2 text-left text-red-400/70">Vol</th>
                <th class="px-2 py-2 text-left text-red-400/70">OI</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-700/30">
            {% set max_ce_oi = namespace(value=0, strike=0) %}
            {% set max_pe_oi = namespace(value=0, strike=0) %}
            {% for row in chain.chain %}
                {% if row.ce.oi and row.ce.oi > max_ce_oi.value %}
                    {% set max_ce_oi.value = row.ce.oi %}
                    {% set max_ce_oi.strike = row.strike %}
                {% endif %}
                {% if row.pe.oi and row.pe.oi > max_pe_oi.value %}
                    {% set max_pe_oi.value = row.pe.oi %}
                    {% set max_pe_oi.strike = row.strike %}
                {% endif %}
            {% endfor %}

            {% for row in chain.chain %}
            <tr class="{% if row.is_atm %}bg-gradient-to-r from-yellow-500/20 via-yellow-500/10 to-yellow-500/20 border-y-2 border-yellow-500/50{% elif row.strike == max_ce_oi.strike %}bg-green-500/5{% elif row.strike == max_pe_oi.strike %}bg-red-500/5{% else %}hover:bg-surface-800/50{% endif %} transition-colors group">
                <!-- CE Side -->
                <td class="px-2 py-2.5 text-right {% if row.strike == max_ce_oi.strike %}bg-green-500/10{% endif %}">
                    <div class="flex items-center justify-end space-x-1">
                        {% if row.strike == max_ce_oi.strike %}
                        <span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>
                        {% endif %}
                        <span class="text-green-400 font-mono text-xs">{{ "{:,}".format(row.ce.oi if row.ce.oi else 0) }}</span>
                    </div>
                </td>
                <td class="px-2 py-2.5 text-right">
                    <span class="text-slate-500 font-mono text-xs">{{ "{:,}".format(row.ce.volume if row.ce.volume else 0) }}</span>
                </td>
                <td class="px-2 py-2.5 text-right">
                    <span class="{% if row.ce.change_pct and row.ce.change_pct > 0 %}text-green-400{% elif row.ce.change_pct and row.ce.change_pct < 0 %}text-red-400{% else %}text-slate-500{% endif %} font-mono text-xs">
                        {{ "{:+.1f}".format(row.ce.change_pct if row.ce.change_pct else 0) }}%
                    </span>
                </td>
                <td class="px-2 py-2.5 text-right">
                    <span class="text-white font-mono font-medium text-sm">{{ "%.2f"|format(row.ce.ltp if row.ce.ltp else 0) }}</span>
                </td>

                <!-- Strike -->
                <td class="px-3 py-2.5 text-center bg-surface-800/70">
                    <div class="flex items-center justify-center space-x-2">
                        <span class="text-white font-black text-sm {% if row.is_atm %}text-yellow-400{% elif row.strike == max_ce_oi.strike %}text-green-400{% elif row.strike == max_pe_oi.strike %}text-red-400{% endif %}">{{ row.strike }}</span>
                        {% if row.is_atm %}
                        <span class="px-1.5 py-0.5 rounded bg-yellow-500/30 text-yellow-400 text-[9px] font-bold">ATM</span>
                        {% elif row.strike == max_ce_oi.strike %}
                        <span class="px-1.5 py-0.5 rounded bg-green-500/30 text-green-400 text-[9px] font-bold">R</span>
                        {% elif row.strike == max_pe_oi.strike %}
                        <span class="px-1.5 py-0.5 rounded bg-red-500/30 text-red-400 text-[9px] font-bold">S</span>
                        {% endif %}
                    </div>
                </td>

                <!-- PE Side -->
                <td class="px-2 py-2.5 text-left">
                    <span class="text-white font-mono font-medium text-sm">{{ "%.2f"|format(row.pe.ltp if row.pe.ltp else 0) }}</span>
                </td>
                <td class="px-2 py-2.5 text-left">
                    <span class="{% if row.pe.change_pct and row.pe.change_pct > 0 %}text-green-400{% elif row.pe.change_pct and row.pe.change_pct < 0 %}text-red-400{% else %}text-slate-500{% endif %} font-mono text-xs">
                        {{ "{:+.1f}".format(row.pe.change_pct if row.pe.change_pct else 0) }}%
                    </span>
                </td>
                <td class="px-2 py-2.5 text-left">
                    <span class="text-slate-500 font-mono text-xs">{{ "{:,}".format(row.pe.volume if row.pe.volume else 0) }}</span>
                </td>
                <td class="px-2 py-2.5 text-left {% if row.strike == max_pe_oi.strike %}bg-red-500/10{% endif %}">
                    <div class="flex items-center space-x-1">
                        <span class="text-red-400 font-mono text-xs">{{ "{:,}".format(row.pe.oi if row.pe.oi else 0) }}</span>
                        {% if row.strike == max_pe_oi.strike %}
                        <span class="w-1.5 h-1.5 rounded-full bg-red-400"></span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot class="bg-gradient-to-r from-green-900/20 via-surface-800 to-red-900/20 text-xs font-bold sticky bottom-0">
            <tr>
                <td class="px-2 py-3 text-right text-green-400 border-t border-slate-700">{{ "{:,}".format(chain.total_ce_oi) }}</td>
                <td class="px-2 py-3 text-right text-slate-500 border-t border-slate-700">-</td>
                <td class="px-2 py-3 text-right text-slate-500 border-t border-slate-700">-</td>
                <td class="px-2 py-3 text-right text-slate-400 border-t border-slate-700">Total</td>
                <td class="px-3 py-3 text-center bg-surface-700/70 border-t border-slate-600">
                    <span class="text-slate-400">CE | PE</span>
                </td>
                <td class="px-2 py-3 text-left text-slate-400 border-t border-slate-700">Total</td>
                <td class="px-2 py-3 text-left text-slate-500 border-t border-slate-700">-</td>
                <td class="px-2 py-3 text-left text-slate-500 border-t border-slate-700">-</td>
                <td class="px-2 py-3 text-left text-red-400 border-t border-slate-700">{{ "{:,}".format(chain.total_pe_oi) }}</td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- Chain Footer with Key Metrics -->
<div class="p-4 bg-gradient-to-r from-surface-800/70 to-surface-900/70 border-t border-slate-700/50">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <!-- Spot Price -->
        <div class="flex items-center space-x-3">
            <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                </svg>
            </div>
            <div>
                <p class="text-slate-500 text-[10px]">Spot</p>
                <p class="text-white font-mono font-bold">{{ "{:,.2f}".format(chain.spot_price) }}</p>
            </div>
        </div>

        <!-- PCR -->
        <div class="flex items-center space-x-3">
            <div class="w-8 h-8 rounded-lg {% if chain.pcr > 1.2 %}bg-green-500/20{% elif chain.pcr < 0.8 %}bg-red-500/20{% else %}bg-slate-500/20{% endif %} flex items-center justify-center">
                <svg class="w-4 h-4 {% if chain.pcr > 1.2 %}text-green-400{% elif chain.pcr < 0.8 %}text-red-400{% else %}text-slate-400{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
            </div>
            <div>
                <p class="text-slate-500 text-[10px]">PCR</p>
                <p class="{% if chain.pcr > 1.2 %}text-green-400{% elif chain.pcr < 0.8 %}text-red-400{% else %}text-white{% endif %} font-mono font-bold">{{ "%.3f"|format(chain.pcr) }}</p>
            </div>
        </div>

        <!-- Max Call OI (Resistance) -->
        <div class="flex items-center space-x-3">
            <div class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center">
                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                </svg>
            </div>
            <div>
                <p class="text-slate-500 text-[10px]">Resistance</p>
                <p class="text-green-400 font-mono font-bold">{{ max_ce_oi.strike }}</p>
            </div>
        </div>

        <!-- Max Put OI (Support) -->
        <div class="flex items-center space-x-3">
            <div class="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center">
                <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
            <div>
                <p class="text-slate-500 text-[10px]">Support</p>
                <p class="text-red-400 font-mono font-bold">{{ max_pe_oi.strike }}</p>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="p-6">
    <div class="h-64 bg-surface-700 rounded-xl animate-pulse"></div>
</div>
{% endif %}
